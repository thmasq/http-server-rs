<!doctype html>
<html lang="en" data-theme="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Directory listing: /{{ current_path }}</title>
        <link
            rel="stylesheet"
            href="https://cdn.vidstack.io/player/theme.css"
        />
        <link
            rel="stylesheet"
            href="https://cdn.vidstack.io/player/video.css"
        />
        <style>
            :root {
                --bg-primary: #ffffff;
                --bg-secondary: #f8f9fa;
                --text-primary: #1a1a1a;
                --text-secondary: #666666;
                --border-color: #eaeaea;
                --hover-color: #f5f5f5;
                --link-color: #0066cc;
            }
            [data-theme="dark"] {
                --bg-primary: #1a1a1a;
                --bg-secondary: #2d2d2d;
                --text-primary: #ffffff;
                --text-secondary: #bbbbbb;
                --border-color: #404040;
                --hover-color: #333333;
                --link-color: #66b3ff;
            }
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                transition:
                    background-color 0.3s,
                    color 0.3s;
            }
            body {
                font-family:
                    system-ui,
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    sans-serif;
                background-color: var(--bg-primary);
                color: var(--text-primary);
                line-height: 1.6;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }
            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px 0;
                border-bottom: 1px solid var(--border-color);
                margin-bottom: 20px;
            }
            .theme-toggle {
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                color: var(--text-primary);
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .theme-toggle:hover {
                background: var(--hover-color);
            }
            table {
                width: 100%;
                border-collapse: collapse;
                background-color: var(--bg-primary);
                border-radius: 8px;
                overflow: hidden;
            }
            th,
            td {
                padding: 12px 16px;
                text-align: left;
                border-bottom: 1px solid var(--border-color);
            }
            th {
                background-color: var(--bg-secondary);
                font-weight: 500;
                color: var(--text-primary);
            }
            tr:hover {
                background-color: var(--hover-color);
            }
            a {
                text-decoration: none;
                color: var(--link-color);
                display: flex;
                align-items: center;
                gap: 8px;
            }
            a:hover {
                text-decoration: underline;
            }
            .size-column {
                width: 150px;
            }
            .modified-column {
                width: 200px;
            }
            .modal {
                display: none;
                position: fixed;
                z-index: 9999;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.9);
                justify-content: center;
                align-items: center;
            }
            .modal-content {
                position: relative;
                width: auto;
                height: auto;
                display: flex;
                justify-content: center;
                align-items: center;
                max-width: 90vw;
                max-height: 90vh;
            }
            .video-container {
                width: 100%;
                height: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            media-player {
                width: 100%;
                height: 100%;
                --media-brand: var(--link-color);
                --media-focus-ring-color: var(--link-color);
            }
            .modal-close {
                position: absolute;
                right: -40px;
                top: -40px;
                background: none;
                border: none;
                color: #fff;
                font-size: 24px;
                cursor: pointer;
                z-index: 1000;
                padding: 10px;
            }
            @media (max-width: 768px) {
                .modal-content {
                    width: 95vw;
                    height: 95vh;
                    padding: 0;
                }
                .modal-close {
                    right: 0;
                    top: -40px;
                }
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h2>Directory listing: /{{ current_path }}</h2>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span class="theme-icon">‚òÄÔ∏è</span>
                <span class="theme-text">Light Mode</span>
            </button>
        </div>
        <table>
            <tr>
                <th>Name</th>
                <th class="size-column">Size</th>
                <th class="modified-column">Modified</th>
            </tr>
            {% if has_parent %}
            <tr>
                <td><a href="/{{ parent_path }}">üìÅ ..</a></td>
                <td>-</td>
                <td>-</td>
            </tr>
            {% endif %} {% for entry in entries %}
            <tr>
                <td>
                    <a href="/{{ entry.path }}">
                        {% if entry.is_dir %}üìÅ{% else %}üìÑ{% endif %} {{
                        entry.name }}
                    </a>
                </td>
                <td>{{ entry.size }}</td>
                <td class="modified-column">{{ entry.modified }}</td>
            </tr>
            {% endfor %}
        </table>
        <script src="https://cdn.vidstack.io/player" type="module"></script>
        <script>
            function toggleTheme() {
                const body = document.documentElement;
                const icon = document.querySelector(".theme-icon");
                const text = document.querySelector(".theme-text");
                const isDark = body.getAttribute("data-theme") === "dark";

                if (isDark) {
                    body.removeAttribute("data-theme");
                    icon.textContent = "üåô";
                    text.textContent = "Dark Mode";
                } else {
                    body.setAttribute("data-theme", "dark");
                    icon.textContent = "‚òÄÔ∏è";
                    text.textContent = "Light Mode";
                }

                localStorage.setItem("theme", isDark ? "light" : "dark");
            }

            class VideoModal {
                constructor() {
                    this.modal = document.createElement("div");
                    this.modal.classList.add("modal");
                    this.modalContent = document.createElement("div");
                    this.modalContent.classList.add("modal-content");
                    this.closeButton = this.createCloseButton();

                    this.modal.appendChild(this.modalContent);
                    this.setupEventListeners();
                }

                createCloseButton() {
                    const button = document.createElement("button");
                    button.classList.add("modal-close");
                    button.innerHTML = "√ó";
                    button.onclick = () => this.close();
                    return button;
                }

                setupEventListeners() {
                    this.modal.addEventListener("click", (event) => {
                        if (event.target === this.modal) this.close();
                    });

                    document.addEventListener("keydown", (event) => {
                        if (event.key === "Escape") this.close();
                    });
                }

                close() {
                    this.modal.style.display = "none";
                    this.modalContent.innerHTML = "";
                    if (this.currentPlayer) {
                        this.currentPlayer.destroy();
                        this.currentPlayer = null;
                    }
                }

                async findSubtitles(videoPath) {
                    const basePath = videoPath.substring(
                        0,
                        videoPath.lastIndexOf("."),
                    );
                    const subtitles = [];

                    for (const ext of [".srt", ".vtt"]) {
                        try {
                            const response = await fetch(`${basePath}${ext}`);
                            if (response.ok) {
                                subtitles.push({
                                    src: `${basePath}${ext}`,
                                    label: `Subtitles (${ext.substring(1)})`,
                                    language: "en",
                                    kind: "subtitles",
                                    default: ext === ".vtt",
                                });
                            }
                        } catch (e) {
                            console.log(`No ${ext} subtitles found`);
                        }
                    }

                    return subtitles;
                }

                async checkDashManifest(videoPath) {
                    const basePath = videoPath.substring(
                        0,
                        videoPath.lastIndexOf("."),
                    );
                    const mpdPath = `${basePath}.mpd`;

                    try {
                        const response = await fetch(mpdPath, {
                            method: "HEAD",
                            headers: {
                                Accept: "application/dash+xml",
                            },
                        });

                        // Only return the MPD path if the server responds with the correct content type
                        if (
                            response.ok &&
                            response.headers
                                .get("content-type")
                                ?.includes("dash+xml")
                        ) {
                            return mpdPath;
                        }
                        console.log(
                            "DASH manifest not found or invalid content type",
                        );
                        return null;
                    } catch (e) {
                        console.log("Error checking DASH manifest:", e);
                        return null;
                    }
                }

                async openVideo(videoSrc) {
                    this.modalContent.innerHTML = "";
                    this.modalContent.appendChild(this.closeButton);

                    const videoContainer = document.createElement("div");
                    videoContainer.classList.add("video-container");
                    videoContainer.id = "video-player-container";
                    this.modalContent.appendChild(videoContainer);
                    this.modal.style.display = "flex";

                    const subtitles = await this.findSubtitles(videoSrc);
                    const dashManifestPath =
                        await this.checkDashManifest(videoSrc);

                    try {
                        const { VidstackPlayer, VidstackPlayerLayout } =
                            await import("https://cdn.vidstack.io/player");

                        let source;
                        if (dashManifestPath) {
                            console.log(
                                "Using DASH manifest:",
                                dashManifestPath,
                            );
                            source = {
                                type: "application/dash+xml",
                                src: dashManifestPath,
                            };
                        } else {
                            console.log(
                                "Falling back to direct video source:",
                                videoSrc,
                            );
                            source = {
                                type: this.getVideoMimeType(videoSrc),
                                src: videoSrc,
                            };
                        }

                        const playerConfig = {
                            target: "#video-player-container",
                            title: videoSrc.split("/").pop(),
                            src: source,
                            tracks: subtitles,
                            controls: true,
                            layout: new VidstackPlayerLayout({}),
                        };

                        this.currentPlayer =
                            await VidstackPlayer.create(playerConfig);
                        this.setupPlayerKeyboardControls();
                    } catch (error) {
                        console.error(
                            "Error initializing video player:",
                            error,
                        );
                        videoContainer.innerHTML = "Error loading video player";
                    }
                }

                getVideoMimeType(videoSrc) {
                    const extension = videoSrc.split(".").pop().toLowerCase();
                    const mimeTypes = {
                        mp4: "video/mp4",
                        webm: "video/webm",
                        mkv: "video/x-matroska",
                    };
                    return mimeTypes[extension] || "video/mp4";
                }

                setupPlayerKeyboardControls() {
                    document.addEventListener("keydown", (e) => {
                        if (
                            this.modal.style.display === "flex" &&
                            this.currentPlayer
                        ) {
                            switch (e.key.toLowerCase()) {
                                case " ":
                                case "p":
                                    e.preventDefault();
                                    this.currentPlayer.paused
                                        ? this.currentPlayer.play()
                                        : this.currentPlayer.pause();
                                    break;
                                case "f":
                                    e.preventDefault();
                                    this.currentPlayer.fullscreen =
                                        !this.currentPlayer.fullscreen;
                                    break;
                                case "m":
                                    e.preventDefault();
                                    this.currentPlayer.muted =
                                        !this.currentPlayer.muted;
                                    break;
                            }
                        }
                    });
                }
            }

            class TableNavigator {
                constructor() {
                    this.currentFocusIndex = -1;
                    this.rows = Array.from(
                        document.querySelectorAll("table tr"),
                    ).slice(1);
                    this.setupEventListeners();
                    this.setupStyles();
                }

                focusRow(index) {
                    this.rows.forEach(
                        (row) => (row.style.backgroundColor = ""),
                    );

                    if (index >= 0 && index < this.rows.length) {
                        this.currentFocusIndex = index;
                        const row = this.rows[this.currentFocusIndex];
                        row.style.backgroundColor = "var(--hover-color)";
                        row.scrollIntoView({
                            block: "nearest",
                            behavior: "smooth",
                        });
                    }
                }

                navigateToParent() {
                    const currentPath = window.location.pathname;
                    const normalizedPath = currentPath.endsWith("/")
                        ? currentPath.slice(0, -1)
                        : currentPath;
                    const pathSegments = normalizedPath.split("/");

                    if (pathSegments.length <= 1) return;

                    pathSegments.pop();
                    const parentPath = pathSegments.join("/") || "/";
                    window.location.href = parentPath;
                }

                handleRowSelection() {
                    if (
                        this.currentFocusIndex >= 0 &&
                        this.currentFocusIndex < this.rows.length
                    ) {
                        const link =
                            this.rows[this.currentFocusIndex].querySelector(
                                "a",
                            );
                        if (link) {
                            const fileName = link.textContent.trim();
                            if (fileName.match(/\.(mp4|webm|ogg)$/i)) {
                                link.dispatchEvent(
                                    new MouseEvent("click", {
                                        bubbles: true,
                                        cancelable: true,
                                        view: window,
                                    }),
                                );
                            } else {
                                window.location.href = link.href;
                            }
                        }
                    }
                }

                setupEventListeners() {
                    document.addEventListener("keydown", (event) => {
                        if (event.target.tagName === "INPUT") return;

                        switch (event.key) {
                            case "ArrowDown":
                            case "j":
                                event.preventDefault();
                                this.focusRow(
                                    this.currentFocusIndex === -1
                                        ? 0
                                        : Math.min(
                                              this.currentFocusIndex + 1,
                                              this.rows.length - 1,
                                          ),
                                );
                                break;

                            case "ArrowUp":
                            case "k":
                                event.preventDefault();
                                this.focusRow(
                                    this.currentFocusIndex === -1
                                        ? this.rows.length - 1
                                        : Math.max(
                                              this.currentFocusIndex - 1,
                                              0,
                                          ),
                                );
                                break;

                            case "Enter":
                            case " ":
                                event.preventDefault();
                                this.handleRowSelection();
                                break;

                            case "Backspace":
                                event.preventDefault();
                                this.navigateToParent();
                                break;

                            case "Home":
                                event.preventDefault();
                                this.focusRow(0);
                                break;

                            case "End":
                                event.preventDefault();
                                this.focusRow(this.rows.length - 1);
                                break;
                        }
                    });

                    this.rows.forEach((row, index) => {
                        row.addEventListener("mouseenter", () =>
                            this.focusRow(index),
                        );
                    });
                }

                setupStyles() {
                    const style = document.createElement("style");
                    style.textContent = `
            tr.keyboard-focused {
                background-color: var(--hover-color) !important;
                outline: 2px solid var(--link-color);
            }
        `;
                    document.head.appendChild(style);
                }
            }

            document.addEventListener("DOMContentLoaded", () => {
                const savedTheme = localStorage.getItem("theme") || "dark";
                const html = document.documentElement;
                const icon = document.querySelector(".theme-icon");
                const text = document.querySelector(".theme-text");

                if (savedTheme === "dark") {
                    html.setAttribute("data-theme", "dark");
                    icon.textContent = "‚òÄÔ∏è";
                    text.textContent = "Light Mode";
                } else {
                    html.removeAttribute("data-theme");
                    icon.textContent = "üåô";
                    text.textContent = "Dark Mode";
                }

                const videoModal = new VideoModal();
                document.body.appendChild(videoModal.modal);

                const links = document.querySelectorAll("a");
                links.forEach((link) => {
                    const fileName = link.textContent.trim();
                    if (fileName.match(/\.(mp4|webm|mkv)$/i)) {
                        link.addEventListener("click", function (event) {
                            event.preventDefault();
                            videoModal.openVideo(link.getAttribute("href"));
                        });
                    }
                });

                const tableNav = new TableNavigator();
                if (tableNav.rows.length > 0) {
                    tableNav.focusRow(0);
                }
            });
        </script>
    </body>
</html>
