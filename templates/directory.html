<!doctype html>
<html lang="en" data-theme="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Directory listing: /{{ current_path }}</title>
        <style>
            :root {
                --bg-primary: #ffffff;
                --bg-secondary: #f8f9fa;
                --text-primary: #1a1a1a;
                --text-secondary: #666666;
                --border-color: #eaeaea;
                --hover-color: #f5f5f5;
                --link-color: #0066cc;
            }
            [data-theme="dark"] {
                --bg-primary: #1a1a1a;
                --bg-secondary: #2d2d2d;
                --text-primary: #ffffff;
                --text-secondary: #bbbbbb;
                --border-color: #404040;
                --hover-color: #333333;
                --link-color: #66b3ff;
            }
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                transition:
                    background-color 0.3s,
                    color 0.3s;
            }
            body {
                font-family:
                    system-ui,
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    sans-serif;
                background-color: var(--bg-primary);
                color: var(--text-primary);
                line-height: 1.6;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }
            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px 0;
                border-bottom: 1px solid var(--border-color);
                margin-bottom: 20px;
            }
            .theme-toggle {
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                color: var(--text-primary);
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .theme-toggle:hover {
                background: var(--hover-color);
            }
            table {
                width: 100%;
                border-collapse: collapse;
                background-color: var(--bg-primary);
                border-radius: 8px;
                overflow: hidden;
            }
            th,
            td {
                padding: 12px 16px;
                text-align: left;
                border-bottom: 1px solid var(--border-color);
            }
            th {
                background-color: var(--bg-secondary);
                font-weight: 500;
                color: var(--text-primary);
            }
            tr:hover {
                background-color: var(--hover-color);
            }
            a {
                text-decoration: none;
                color: var(--link-color);
                display: flex;
                align-items: center;
                gap: 8px;
            }
            a:hover {
                text-decoration: underline;
            }
            .size-column {
                width: 150px;
            }
            .modified-column {
                width: 200px;
            }
            @media (max-width: 768px) {
                .modified-column {
                    display: none;
                }
                .size-column {
                    width: 100px;
                }
                th,
                td {
                    padding: 12px 8px;
                }
            }
            .modal {
                display: none;
                position: fixed;
                z-index: 9999;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.8);
                justify-content: center;
                align-items: center;
                overflow: auto;
            }
            .modal-content {
                position: relative;
                max-width: 90%;
                max-height: 80%;
                background-color: #fff;
                padding: 4px;
                border-radius: 2px;
            }
            .modal video {
                width: 100%;
                height: auto;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h2>Directory listing: /{{ current_path }}</h2>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span class="theme-icon">‚òÄÔ∏è</span>
                <span class="theme-text">Light Mode</span>
            </button>
        </div>
        <table>
            <tr>
                <th>Name</th>
                <th class="size-column">Size</th>
                <th class="modified-column">Modified</th>
            </tr>
            {% if has_parent %}
            <tr>
                <td><a href="/{{ parent_path }}">üìÅ ..</a></td>
                <td>-</td>
                <td>-</td>
            </tr>
            {% endif %} {% for entry in entries %}
            <tr>
                <td>
                    <a href="/{{ entry.path }}">
                        {% if entry.is_dir %}üìÅ{% else %}üìÑ{% endif %} {{
                        entry.name }}
                    </a>
                </td>
                <td>{{ entry.size }}</td>
                <td class="modified-column">{{ entry.modified }}</td>
            </tr>
            {% endfor %}
        </table>
        <script>
            function toggleTheme() {
                const body = document.documentElement;
                const button = document.querySelector(".theme-toggle");
                const icon = document.querySelector(".theme-icon");
                const text = document.querySelector(".theme-text");

                if (body.getAttribute("data-theme") === "dark") {
                    body.removeAttribute("data-theme");
                    icon.textContent = "üåô";
                    text.textContent = "Dark Mode";
                } else {
                    body.setAttribute("data-theme", "dark");
                    icon.textContent = "‚òÄÔ∏è";
                    text.textContent = "Light Mode";
                }

                localStorage.setItem(
                    "theme",
                    body.getAttribute("data-theme") || "light",
                );
            }

            document.addEventListener("DOMContentLoaded", () => {
                const savedTheme = localStorage.getItem("theme") || "dark";
                const html = document.documentElement;
                const icon = document.querySelector(".theme-icon");
                const text = document.querySelector(".theme-text");

                if (savedTheme === "dark") {
                    html.setAttribute("data-theme", "dark");
                    icon.textContent = "‚òÄÔ∏è";
                    text.textContent = "Light Mode";
                } else {
                    html.removeAttribute("data-theme");
                    icon.textContent = "üåô";
                    text.textContent = "Dark Mode";
                }
            });
            document.addEventListener("DOMContentLoaded", () => {
                const videoMimeTypes = ["video/mp4", "video/webm", "video/mkv"];

                const modal = document.createElement("div");
                modal.classList.add("modal");
                const modalContent = document.createElement("div");
                modalContent.classList.add("modal-content");
                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                function openVideoModal(videoSrc) {
                    const videoPlayer = document.createElement("video");
                    videoPlayer.controls = true;
                    videoPlayer.src = videoSrc;
                    modalContent.appendChild(videoPlayer);
                    modal.style.display = "flex";
                }

                modal.addEventListener("click", (event) => {
                    if (event.target === modal) {
                        modal.style.display = "none";
                        modalContent.innerHTML = "";
                        modalContent.appendChild(closeButton);
                    }
                });

                const links = document.querySelectorAll("a");

                links.forEach((link) => {
                    const filePath = link.getAttribute("href");
                    const fileName = link.textContent.trim();

                    if (fileName.match(/\.(mp4|webm|ogg)$/i)) {
                        link.addEventListener("click", function (event) {
                            event.preventDefault();
                            openVideoModal(link.getAttribute("href"));
                        });
                    }
                });
                document.addEventListener("keydown", (event) => {
                    if (event.key === "Escape") {
                        modal.style.display = "none";
                        modalContent.innerHTML = "";
                    }
                });
            });

            document.addEventListener("DOMContentLoaded", () => {
                let currentFocusIndex = -1;
                const rows = Array.from(
                    document.querySelectorAll("table tr"),
                ).slice(1);

                function focusRow(index) {
                    rows.forEach((row) => (row.style.backgroundColor = ""));

                    if (index >= 0 && index < rows.length) {
                        currentFocusIndex = index;
                        const row = rows[currentFocusIndex];
                        row.style.backgroundColor = "var(--hover-color)";
                        row.scrollIntoView({
                            block: "nearest",
                            behavior: "smooth",
                        });
                    }
                }

                function navigateToParent() {
                    const currentPath = window.location.pathname;
                    const normalizedPath = currentPath.endsWith("/")
                        ? currentPath.slice(0, -1)
                        : currentPath;

                    const pathSegments = normalizedPath.split("/");

                    if (pathSegments.length <= 1) return;

                    pathSegments.pop();
                    const parentPath = pathSegments.join("/") || "/";

                    window.location.href = parentPath;
                }

                function handleRowSelection() {
                    if (
                        currentFocusIndex >= 0 &&
                        currentFocusIndex < rows.length
                    ) {
                        const link = rows[currentFocusIndex].querySelector("a");
                        if (link) {
                            const fileName = link.textContent.trim();
                            if (fileName.match(/\.(mp4|webm|ogg)$/i)) {
                                const event = new MouseEvent("click", {
                                    bubbles: true,
                                    cancelable: true,
                                    view: window,
                                });
                                link.dispatchEvent(event);
                            } else {
                                window.location.href = link.href;
                            }
                        }
                    }
                }

                document.addEventListener("keydown", (event) => {
                    if (event.target.tagName === "INPUT") return;

                    switch (event.key) {
                        case "ArrowDown":
                        case "j":
                            event.preventDefault();
                            focusRow(
                                currentFocusIndex === -1
                                    ? 0
                                    : Math.min(
                                          currentFocusIndex + 1,
                                          rows.length - 1,
                                      ),
                            );
                            break;

                        case "ArrowUp":
                        case "k":
                            event.preventDefault();
                            focusRow(
                                currentFocusIndex === -1
                                    ? rows.length - 1
                                    : Math.max(currentFocusIndex - 1, 0),
                            );
                            break;

                        case "Enter":
                        case " ":
                            event.preventDefault();
                            handleRowSelection();
                            break;

                        case "Backspace":
                            event.preventDefault();
                            navigateToParent();
                            break;

                        case "Home":
                            event.preventDefault();
                            focusRow(0);
                            break;

                        case "End":
                            event.preventDefault();
                            focusRow(rows.length - 1);
                            break;
                    }
                });

                rows.forEach((row, index) => {
                    row.addEventListener("mouseenter", () => {
                        focusRow(index);
                    });
                });

                if (rows.length > 0) {
                    focusRow(0);
                }

                const style = document.createElement("style");
                style.textContent = `
        tr.keyboard-focused {
            background-color: var(--hover-color) !important;
            outline: 2px solid var(--link-color);
        }
    `;
                document.head.appendChild(style);
            });
        </script>
    </body>
</html>
